# LOVE Multiplatform GitLab CI

# Fill in the project info
variables:
        PROJECT: demonizer
        PROJECT_TITLE: Demonizer
        PROJECT_TITLE_NOSPACE: Demonizer
        DESCRIPTION: "Demonic corruption fantasy shmup"
        COPYRIGHT: "Â© 2019 IoriBranford"
        APPLICATION_ID_BASE: "io.itch.ioribranford.demonizer"
        LOVE_VERSION: "0.10.2"
        SCREEN_ORIENTATION: "sensorPortrait"
        GAME_TYPE: full
        VERSION: "${CI_COMMIT_REF_NAME}"
        GIT_DEPTH: "1"
        # GIT_SUBMODULE_STRATEGY: recursive
        # broken by https://gitlab.com/gitlab-org/gitlab-ci-multi-runner/issues/2148

# Fill in the demo info if providing a demo
.demo:
        <<: &demo
                only:
                        - master
                        - /demo/
        variables:
                <<: &demo-variables
                        PROJECT_TITLE: "Demonizer Demo"
                        PROJECT_TITLE_NOSPACE: "Demonizer_Demo"
                        GAME_TYPE: demo

.full:
        <<: &full
                except:
                        - /demo/

stages:
        - build

image: alpine:latest

before_script:
        - apk add --update git zip luajit
        - git submodule sync --recursive
        - git submodule update --init --recursive
          # workaround https://gitlab.com/gitlab-org/gitlab-ci-multi-runner/issues/2148

.debian:
        <<: &debian
                before_script:
                        - apt-get update
                        - apt-get install -y -qq git zip luajit
                        - git submodule sync --recursive
                        - git submodule update --init --recursive

.build-data: &build-data
        stage: build
        script:
                - apk add wget xz
                - ./make-game.sh
                - mv ${GAME_TYPE}.love "${PROJECT}-${GAME_TYPE}.love"
        artifacts:
                name: "${PROJECT}-${VERSION}-data"
                paths:
                        - "${PROJECT}-${GAME_TYPE}.love"
                expire_in: 1 week

.build-linux: &build-linux
        <<: *debian
        stage: build
        image: debian:stretch-slim
        script:
                - apt-get install -y -qq file wget fuse libglib2.0-0
                - ./make-game.sh
                - ./make-linux.sh
        cache:
                key: "${PROJECT}-linux-${ARCH}"
                paths:
                        - "love-${LOVE_VERSION}-${ARCH}.AppImage"
                        - "appimagetool-${ARCH}.AppImage"
                        - "*.deb"
        artifacts:
                name: "${PROJECT}-${VERSION}-linux-${ARCH}"
                paths:
                        - ${PROJECT_TITLE_NOSPACE}-${ARCH}.AppImage
                expire_in: 1 week

.build-windows: &build-windows
        <<: *debian
        image: tianon/wine
        stage: build
        variables:
                ARCH_BITS: "64"
        script:
                - apt-get install -y -qq wget xz-utils xvfb
                - ./make-game.sh
                - ./make-windows.sh
        cache:
                key: "${PROJECT}-win-${ARCH_BITS}"
                paths:
                        - "love-${LOVE_VERSION}-win${ARCH_BITS}.zip"
                        - "libgme_0.6.2_msvc12.zip"
                        - "resource_hacker.zip"
        artifacts:
                name: "${PROJECT}-${VERSION}-win${ARCH_BITS}"
                paths:
                        - "${PROJECT_TITLE}"
                expire_in: 1 week

.build-dev-windows: &build-dev-windows
        stage: build
        variables:
                ARCH_BITS: "64"
        script:
                - apk add wget
                - ./make-dev-windows.sh
        cache:
                key: "${PROJECT}-win-${ARCH_BITS}"
                paths:
                        - "love-${LOVE_VERSION}-win${ARCH_BITS}.zip"
                        - "libgme_0.6.2_msvc12.zip"
        artifacts:
                name: "${PROJECT}-dev-win${ARCH_BITS}"
                paths:
                        - "${PROJECT_TITLE}"

.build-osx: &build-osx
        <<: *debian
        stage: build
        image: fzwoch/osxcross
        variables:
                CFBundleIdentifier: "${APPLICATION_ID_BASE}"
                <<: &build-osx-variables
                        NSHumanReadableCopyright: "${COPYRIGHT}"
                        INSTALL_NAME_TOOL: x86_64-apple-darwin12-install_name_tool
        script:
                - apt-get install -y -qq wget xz-utils
                - ./make-game.sh
                - ./make-macosx.sh
        cache:
                key: "${PROJECT}-osx"
                paths:
                        - "love-${LOVE_VERSION}-macosx-x64.zip"
                        - "game-music-emu-0.6.1.yosemite.bottle.tar.gz"
        artifacts:
                name: "${PROJECT}-${VERSION}-osx"
                paths:
                        - "${PROJECT_TITLE}.app"
                expire_in: 1 week

.build-android: &build-android
        <<: *debian
        stage: build
        image: lakoo/android-ndk:26-28.0.2-r17b
        variables:
                APPLICATION_ID: "${APPLICATION_ID_BASE}"
        script:
                - apt-get install -y -qq make file
                - ./make-game.sh
                - ./configure-android.sh
                - ./make-android.sh
        cache:
                key: "${PROJECT}-android"
                paths:
                        - love-android-sdl2
        artifacts:
                name: "${PROJECT}-${VERSION}-android"
                paths:
                        - "${PROJECT_TITLE_NOSPACE}.apk"
                expire_in: 1 week

data:
        <<: *build-data
        <<: *full

linux-x86_64:
        <<: *build-linux
        <<: *full
        variables:
                ARCH: "x86_64"

linux-i686:
        <<: *build-linux
        <<: *full
        image: i386/debian:stretch-slim
        variables:
                ARCH: "i686"

win-64:
        <<: *build-windows
        <<: *full

win-32:
        <<: *build-windows
        <<: *full
        variables:
                ARCH_BITS: "32"

osx:
        <<: *build-osx
        <<: *full

android:
        <<: *build-android
        <<: *full

demo-data:
        <<: *build-data
        <<: *demo
        variables:
                <<: *demo-variables

demo-linux-x86_64:
        <<: *build-linux
        <<: *demo
        variables:
                ARCH: "x86_64"
                <<: *demo-variables

demo-linux-i686:
        <<: *build-linux
        <<: *demo
        image: i386/debian:stretch-slim
        variables:
                ARCH: "i686"
                <<: *demo-variables

demo-win-64:
        <<: *build-windows
        <<: *demo
        variables:
                <<: *demo-variables
                ARCH_BITS: "64"

demo-win-32:
        <<: *build-windows
        <<: *demo
        variables:
                <<: *demo-variables
                ARCH_BITS: "32"

demo-osx:
        <<: *build-osx
        <<: *demo
        variables:
                <<: *demo-variables
                <<: *build-osx-variables
                CFBundleIdentifier: "${APPLICATION_ID_BASE}demo"

demo-android:
        <<: *build-android
        <<: *demo
        variables:
                <<: *demo-variables
                APPLICATION_ID: "${APPLICATION_ID_BASE}demo"

dev-win-64:
        <<: *build-dev-windows
        <<: *full

dev-win-32:
        <<: *build-dev-windows
        <<: *full
        variables:
                ARCH_BITS: "32"
